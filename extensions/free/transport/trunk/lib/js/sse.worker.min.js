let workerId="";const SSE={},retryTimeout=5e3,retryLimit=5,_log=(...a)=>postMessage({workerId,log:a}),_resolve=(...a)=>postMessage({workerId,resolve:a}),_reject=(...a)=>postMessage({workerId,reject:a});onerror=(a,b,c,d,e)=>postMessage({workerId,error:e}),onmessage=a=>{workerId=a.data.id,SSE?.[workerId]?.close();const{handle:b,formData:c,logStart:d,urlData:e,nonce:f,logMessages:g}=a.data.data,h=new URL(e.endpoint,e.base);h.searchParams.set("action","tsfem_e_transport"),h.searchParams.set("handle",b),h.searchParams.set("nonce",f),h.searchParams.set("data",c);let i=0,j=1;const k=()=>{h.searchParams.set("retryAllowed",j),SSE[workerId]=new EventSource(h.href),SSE[workerId].onopen=()=>{_log(d),_log("&nbsp;")},SSE[workerId].onerror=()=>{SSE[workerId].close(),_log(g.unknownErrorFull,2),_reject(g.unknownError)};const a=a=>{try{return JSON.parse(a)}catch(a){}},b=b=>{SSE[workerId].close();let c=a(b.data);_log("\n\n"+c.logMsg,2),_resolve(c?.results.notice)},c=b=>{SSE[workerId].close();let c=a(b.data);_log("&nbsp;"),_log(c?.logMsg,2),_resolve(c?.results.notice)},e=b=>{if(i++,_log("===============",1),i>retryLimit)return _log(g.retryLimitReached),c(b);j=i<retryLimit?1:0,SSE[workerId].close(),_log(a(b.data)?.logMsg,1);let d=1;const e=setInterval(()=>{let a=retryTimeout/1e3-d++,b=2>a;_log(g.retryCountdown.replace("%d",a),b?1:0),b&&clearInterval(e)},1e3);setTimeout(k,retryTimeout)};SSE[workerId].addEventListener("tsfem-e-transport-log",b=>{_log(a(b.data)?.content)}),SSE[workerId].addEventListener("tsfem-e-transport-done",b),SSE[workerId].addEventListener("tsfem-e-transport-failure",c),SSE[workerId].addEventListener("tsfem-e-transport-locked",c),SSE[workerId].addEventListener("tsfem-e-transport-crash",e),SSE[workerId].addEventListener("tsfem-e-transport-timeout",e)};k()};
